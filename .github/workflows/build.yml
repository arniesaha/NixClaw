name: Build NixClaw

on:
  push:
    branches: [main, feat/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, macOS, ARM64, xcode]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Unlock Keychain
        run: |
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project NixClaw.xcodeproj \
            -scheme NixClaw

      - name: Create build config
        run: |
          cat > Config/Nix.xcconfig << EOF
          #include "NixClaw.xcconfig"
          APP_DISPLAY_NAME = NixClaw
          DEFAULT_ASSISTANT_NAME = Nix
          GEMINI_API_KEY = ${{ secrets.GEMINI_API_KEY }}
          DEFAULT_OPENCLAW_SCHEME = ${{ secrets.OPENCLAW_SCHEME }}
          DEFAULT_OPENCLAW_HOSTNAME = ${{ secrets.OPENCLAW_HOSTNAME }}
          DEFAULT_OPENCLAW_PORT = ${{ secrets.OPENCLAW_PORT }}
          DEFAULT_OPENCLAW_TOKEN = ${{ secrets.OPENCLAW_TOKEN }}
          DEFAULT_UPLOAD_SERVER_PORT = ${{ secrets.UPLOAD_SERVER_PORT }}
          DEFAULT_UPLOAD_SERVER_TOKEN = ${{ secrets.UPLOAD_SERVER_TOKEN }}
          EOF

      - name: Build for Device
        run: |
          xcodebuild build \
            -project NixClaw.xcodeproj \
            -scheme NixClaw \
            -destination "platform=iOS,id=00008150-000E22603CC2401C" \
            -configuration Debug \
            -derivedDataPath build \
            | xcbeautify || tail -50

      - name: Install on iPhone
        run: |
          APP_PATH=$(find build -name "NixClaw.app" -type d | head -1)
          echo "Installing: $APP_PATH"
          xcrun devicectl device install app --device 00008150-000E22603CC2401C "$APP_PATH"

      - name: Report
        if: always()
        run: |
          echo "Build completed at $(date)"
          echo "Branch: ${{ github.ref_name }}"
